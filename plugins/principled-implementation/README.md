# principled-implementation

Orchestrate DDD plan execution via worktree-isolated Claude Code agents.

## What It Does

The principled-implementation plugin bridges the gap between planning and execution in specification-first development. It reads DDD implementation plans generated by the [principled-docs](../principled-docs/) plugin and automates their execution by:

1. **Decomposing** plans into executable tasks with dependency ordering
2. **Spawning** Claude Code agents in isolated git worktrees per task
3. **Validating** implementations via the project's test suite and checks
4. **Merging** completed work back to the working branch
5. **Orchestrating** the full lifecycle end-to-end

## Skills

| Skill           | Command                             | Category   | Description                                                    |
| --------------- | ----------------------------------- | ---------- | -------------------------------------------------------------- |
| `impl-strategy` | _(background)_                      | Knowledge  | Orchestration strategy, task lifecycle, manifest schema        |
| `decompose`     | `/decompose <plan-path>`            | Analytical | Extract tasks from a DDD plan into a manifest                  |
| `spawn`         | `/spawn <task-id>`                  | Generative | Execute a task in an isolated worktree via impl-worker agent   |
| `check-impl`    | `/check-impl [--task <id>] [--all]` | Analytical | Validate implementations against project checks                |
| `merge-work`    | `/merge-work <task-id>`             | Generative | Merge a validated task's branch and clean up                   |
| `orchestrate`   | `/orchestrate <plan-path>`          | Generative | Full automated lifecycle: decompose → spawn → validate → merge |

## Agents

| Agent         | Isolation  | Description                                        |
| ------------- | ---------- | -------------------------------------------------- |
| `impl-worker` | `worktree` | Executes a single task in an isolated git worktree |

## Architecture

```
/orchestrate (inline)
  ├── Decompose plan → .impl/manifest.json
  ├── For each phase (sequential):
  │   ├── For each task:
  │   │   ├── /spawn <task-id> → impl-worker agent (worktree)
  │   │   ├── /check-impl → run project checks
  │   │   └── /merge-work → merge branch, cleanup
  │   └── Phase complete
  └── Final summary
```

### Worktree Isolation

Each task executes in its own git worktree via the `impl-worker` agent's `isolation: worktree` setting. Claude Code automatically creates and manages the worktree. The agent creates a named branch (`impl/<plan-number>/<task-id>`), implements the task, and commits.

### Task Manifest

The manifest at `.impl/manifest.json` tracks all task state. It is managed by scripts and the orchestrator — not by worktree agents (which cannot access the main working tree's filesystem).

### Error Recovery

- **Failed checks**: retry up to 2 times with failure context
- **Merge conflicts**: pause for manual resolution, resume with `--continue`
- **Interrupted**: resume from manifest state with `--continue`

## Quick Start

```bash
# Decompose a DDD plan into tasks
/decompose docs/plans/003-new-feature.md

# Execute a single task
/spawn 1.1

# Validate the implementation
/check-impl --task 1.1

# Merge back to working branch
/merge-work 1.1

# Or run the full pipeline automatically
/orchestrate docs/plans/003-new-feature.md
```

## Script Duplication

Following the principled-docs convention, shared scripts are duplicated across consuming skills with byte-identical copies. The drift check script verifies all copies match:

```bash
bash plugins/principled-implementation/scripts/check-template-drift.sh
```

| Canonical                            | Copies To                                                      |
| ------------------------------------ | -------------------------------------------------------------- |
| `decompose/scripts/parse-plan.sh`    | `orchestrate/scripts/`                                         |
| `decompose/scripts/task-manifest.sh` | `spawn/`, `check-impl/`, `merge-work/`, `orchestrate/` scripts |
| `check-impl/scripts/run-checks.sh`   | `orchestrate/scripts/`                                         |
| `spawn/templates/claude-task.md`     | `orchestrate/templates/`                                       |

## Hooks

| Hook                        | Event                    | Description                                         |
| --------------------------- | ------------------------ | --------------------------------------------------- |
| Manifest Integrity Advisory | PreToolUse (Edit\|Write) | Warns when `.impl/manifest.json` is edited directly |

## Dependencies

- **Claude Code v2.1.3+** (skills, agents, worktree isolation)
- **Bash** (all scripts are pure bash)
- **Git** (worktree management)
- **jq** (optional — scripts fall back to grep/sed)
